---
import BaseLayout from "../layouts/BaseLayout.astro";
import { getCollection, getEntry } from "astro:content";
import { withBase } from "../utils/paths";

const chapters = (await getCollection("tutorial"))
  .sort((a, b) => a.data.order - b.data.order);
const siteEntry = await getEntry("site", "resources").catch(() => null);
const downloadsConfig = siteEntry?.data.downloads ?? {
  enabled: true,
  title: "配套资源下载",
  description: "所有示例工作流均经过实机验证，可直接导入 ComfyUI。",
  items: []
};
const resolveUrl = (value?: string | null) => withBase(value) ?? value ?? undefined;

const firstChapter = chapters[0];
const secondChapter = chapters[1];
const primaryCtaAnchor = secondChapter ? `#${secondChapter.slug}` : firstChapter ? `#${firstChapter.slug}` : "#downloads";
const secondaryCtaAnchor = firstChapter ? `#${firstChapter.slug}` : "#downloads";
---
<BaseLayout>
  <section class="rounded-3xl bg-gradient-to-br from-primary/10 via-surface-light to-muted-light p-10 text-slate-800 shadow-lg ring-1 ring-primary/20 dark:from-primary/15 dark:via-surface-dark dark:to-muted-dark dark:text-slate-100">
    <div class="max-w-3xl space-y-6">
      <p class="text-sm uppercase tracking-[0.35em] text-primary">ComfyUI 快速上手</p>
      <h1 class="text-4xl font-bold sm:text-5xl">从核心概念到常用工作流，30 分钟建立你的 ComfyUI 直觉</h1>
      <p class="text-lg text-slate-600 dark:text-slate-300">
        本教程专注于最常用、实用的 ComfyUI 工作流。新增教程会自动出现在首页，帮助你逐个掌握常见场景。
      </p>
      <div class="flex flex-wrap gap-3 text-sm">
        <a class="rounded-md bg-primary px-4 py-2 font-semibold text-white shadow-lg shadow-primary/30 transition hover:bg-primary-dark" href={primaryCtaAnchor}>直接开始动手</a>
        <a class="rounded-md border border-primary px-4 py-2 font-semibold text-primary transition hover:bg-primary/10" href={secondaryCtaAnchor}>先熟悉核心概念</a>
      </div>
    </div>
  </section>

  {chapters.map((chapter, index) => {
    const orderNumber = chapter.data.order ?? index + 1;
    const displayNumber = orderNumber.toString().padStart(2, "0");
    const mediaSrc = chapter.data.gifDemo ?? chapter.data.heroImage;
    const mediaAlt = chapter.data.gifDemo ? `${chapter.data.title} 动图演示` : `${chapter.data.title} 示意图`;
    const keywords = chapter.data.keywords ?? [];
    const deliverables = chapter.data.deliverables ?? [];
    const extraButtons = chapter.data.ctaButtons ?? [];
    const ctas = [
      { label: "阅读完整章节", url: `tutorial/${chapter.slug}/`, download: false },
      ...extraButtons
    ];

    return (
      <section id={chapter.slug} data-chapter-id={chapter.slug} class={`space-y-6 ${index === 0 ? "mt-16" : "mt-24"}`}>
        <header class="flex flex-col gap-2">
          <p class="text-xs font-semibold uppercase tracking-[0.3em] text-primary">章节 {displayNumber}</p>
          <h2 class="text-3xl font-bold">{chapter.data.title}</h2>
          <p class="text-slate-600 dark:text-slate-300">{chapter.data.description}</p>
        </header>
        <article
          class:list={{
            "rounded-2xl border border-slate-200 bg-white/80 p-8 shadow-sm backdrop-blur dark:border-slate-700 dark:bg-slate-900/70": true,
            "grid gap-8 md:grid-cols-[minmax(0,1fr)_minmax(0,1fr)]": Boolean(mediaSrc),
            "flex flex-col gap-6": !mediaSrc
          }}
        >
          {mediaSrc && (
            <img src={resolveUrl(mediaSrc)} alt={mediaAlt} class="w-full rounded-xl border border-primary/20 shadow-lg" loading="lazy" />
          )}
          <div class="flex flex-col gap-4">
            <p class="text-sm leading-relaxed text-slate-600 dark:text-slate-300">{chapter.data.goal ?? chapter.data.description}</p>
            {keywords.length > 0 && (
              <ul class="flex flex-wrap gap-2 text-xs text-primary">
                {keywords.map((keyword) => (
                  <li class="rounded-full border border-primary/40 px-3 py-1">{keyword}</li>
                ))}
              </ul>
            )}
            {(chapter.data.goal || chapter.data.duration || chapter.data.difficulty) && (
              <dl class="grid gap-4 text-xs text-slate-500 dark:text-slate-300 sm:grid-cols-3">
                {chapter.data.goal && (
                  <div>
                    <dt class="font-semibold text-slate-600 dark:text-slate-200">学习目标</dt>
                    <dd class="mt-1 text-slate-600 dark:text-slate-300">{chapter.data.goal}</dd>
                  </div>
                )}
                {chapter.data.duration && (
                  <div>
                    <dt class="font-semibold text-slate-600 dark:text-slate-200">预计时间</dt>
                    <dd class="mt-1 text-slate-600 dark:text-slate-300">{chapter.data.duration}</dd>
                  </div>
                )}
                {chapter.data.difficulty && (
                  <div>
                    <dt class="font-semibold text-slate-600 dark:text-slate-200">难度</dt>
                    <dd class="mt-1 text-slate-600 dark:text-slate-300">{chapter.data.difficulty}</dd>
                  </div>
                )}
              </dl>
            )}
            {deliverables.length > 0 && (
              <div class="space-y-2">
                <p class="text-sm font-semibold text-slate-700 dark:text-slate-200">完成后你将获得</p>
                <ul class="list-disc space-y-1 pl-5 text-sm leading-snug text-slate-600 dark:text-slate-300">
                  {deliverables.map((item) => (
                    <li>{item}</li>
                  ))}
                </ul>
              </div>
            )}
            <div class="mt-auto flex flex-wrap gap-4 text-sm">
              {ctas.map((cta, ctaIndex) => (
                <a
                  class={ctaIndex === 0
                    ? "inline-flex items-center gap-2 rounded-md border border-primary px-4 py-2 font-semibold text-primary transition hover:bg-primary/10"
                    : "inline-flex items-center gap-2 rounded-md border border-primary/40 px-4 py-2 font-semibold text-primary transition hover:bg-primary/10"}
                  href={resolveUrl(cta.url)}
                  download={cta.download ? "" : undefined}
                >
                  {cta.label}
                </a>
              ))}
            </div>
          </div>
        </article>
      </section>
    );
  })}

  {downloadsConfig.enabled && downloadsConfig.items.length > 0 && (
    <section id="downloads" data-chapter-id="downloads" class="mt-24 space-y-4 rounded-3xl border border-primary/30 bg-primary/5 p-10 shadow-lg dark:border-primary/40 dark:bg-primary/10">
      <div>
        <h2 class="text-2xl font-bold">{downloadsConfig.title}</h2>
        {downloadsConfig.description && (
          <p class="mt-2 text-sm text-slate-600 dark:text-slate-300">{downloadsConfig.description}</p>
        )}
      </div>
      <ul class="mt-2 space-y-3 text-sm">
        {downloadsConfig.items.map((item) => (
          <li>
            <a
              class="inline-flex items-center gap-2 rounded-md bg-white px-4 py-2 font-semibold text-primary shadow-sm ring-1 ring-primary/30 transition hover:bg-primary/10 dark:bg-slate-900"
              href={resolveUrl(item.url)}
              download={item.download ? "" : undefined}
            >
              {item.label}
            </a>
          </li>
        ))}
      </ul>
    </section>
  )}
</BaseLayout>

